<!DOCTYPE html>
<html>
<head>
	<title>Path Generator 2</title>
	<script type = "text/javascript" src = "https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.js"></script>
	<script type = "text/javascript" src = "https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.14.1/math.js"></script>
</head>
<body>
<svg id = "pathFinding" width = 500 height = 500></svg>
<script type="text/javascript">
	var pathFind = d3.select("#pathFinding");

	var width = 300;
	var sizeXY = 5;
	var sizeZ = 5;
	var step = width/(sizeXY-1);
	var padding = (pathFind.attr("width")-width)/2;
	var length = step/2;
	var rect = pathFind.append("rect").attr("width", width).attr("height", width).attr("x", padding).attr("y", padding).attr("fill", "AliceBlue");
	var stack = [];
	var cubeSize = 1;

	var order = [
		{i:0, j:0, dir: "n", type: "junctionCorner"},
		{i:1, j:0, dir: "n", type: "normal"},
		{i:2, j:0, dir: "n", type: "junction"},
		{i:3, j:0, dir: "n", type: "normal"},
		{i:4, j:0, dir: "e", type: "junctionCorner"},
		{i:4, j:1, dir: "e", type: "normal"},
		{i:4, j:2, dir: "e", type: "junction"},
		{i:4, j:3, dir: "e", type: "normal"},
		{i:4, j:4, dir: "s", type: "junctionCorner"},
		{i:3, j:4, dir: "s", type: "normal"},
		{i:2, j:4, dir: "s", type: "junction"},
		{i:1, j:4, dir: "s", type: "normal"},
		{i:0, j:4, dir: "w", type: "junctionCorner"},
		{i:0, j:3, dir: "w", type: "normal"},
		{i:0, j:2, dir: "w", type: "junction"},
		{i:0, j:1, dir: "n", type: "normalCorner"},
		{i:1, j:1, dir: "n", connection: [0,0]},
		{i:2, j:1, dir: "n", connection: [2,0]},
		{i:3, j:1, dir: "e", connection: [4,0]},
		{i:3, j:2, dir: "e", connection: [4,2]},
		{i:3, j:3, dir: "s", connection: [4,4]},
		{i:2, j:3, dir: "s", connection: [2,4]},
		{i:1, j:3, dir: "w", connection: [0,4]},
		{i:1, j:2, dir: "w", connection: [0,2]},
		{i:2, j:2, dir: null}
	]

	var regularLoop = {
		//2 -> 1 -> 3
		//MAIN LOOP (Entry and Exit through bottom face)
		spline1: [
			[-0.35, 0, -0.5],
			[-0.4, -0.175, 0.175],
			[-0.375, 0.05, 0.3],
			[0, 0.4, 0.4],
			[0.375, 0.05, 0.3],
			[0.4, -0.175, 0.175],
			[0.35, 0, -0.5]
		],
		//RIGHT CROSS (Entry through right face, Exit through top face)
		spline2: [
			[0.5, 0, 0],
			[-0.02, -0.1, 0.25],
			[-0.35, 0, 0.5]
		],
		//LEFT CROSS (Entry through left face, Exit through top face)
		spline3: [
			[0.35, 0, 0.5],
			[0.02, 0.1, 0.25],
			[-0.5, 0, 0],
		]
	}

	var regularCornerLoop = {
		//2 -> 1 -> 3
		//SPLINE 1 MAIN LOOP (Entry and Exit through bottom face)
		spline1: [
			[-0.247, -0.247, -0.5],
			[-0.141, -0.389, 0.175],
			[-0.301, -0.23, 0.3],
			[-0.283, 0.283, 0.4],
			[0.23, 0.301, 0.3],
			[0.389, 0.141, 0.175],
			[0.247, 0.247, -0.5],
		],
		//SPLINE 2 RIGHT CROSS (Entry through back face, Exit through top face)
		spline2: [
			[0, 0.5, 0],
			[0.057, -0.085, 0.25],
			[-0.247, -0.247, 0.5],
		],
		//SPLINE 3 LEFT CROSS (Entry through left face, Exit through top face)
		spline3:[
			[0.247, 0.247, 0.5],
			[-0.057, 0.085, 0.25],
			[-0.5, 0, 0],
		]
	}

	var junctionLoop = {
		//FIRST PASS: 2 (separate)
		//SECOND PASS: 3, 5 (cube below), 1, 4 (cube below), 6
		
		//MAIN FRONT LOOP (Entry and Exit through bottom face) 
		spline1: [
			[-0.3, -0.1, -0.25],
			[-0.4, -0.175, 0.175],
			[-0.375, 0, 0.3],
			[0, 0.3, 0.4],
			[0.375, 0, 0.3],
			[0.4, -0.175, 0.175],
			[0.3, -0.1, -0.25],
		],
		//SECOND FRONT LOOP (Entry through left face, Exit through right face)
		spline2: [
			[-0.5, 0, -0.25],
			[-0.1, 0.45, -0.25],
			[0.4, 0.375, 0.175],
			[0.375, 0.5, 0.3],
			[0, 0.7, 0.4],
			[-0.375, 0.5, 0.3],
			[-0.4, 0.325, 0.175],
			[0.1, 0.2, -0.25],
			[0.5, 0, -0.25],
		],
		//MAIN BACK LOOP (Entry through right face, Exit through bottom face)
		spline3: [
			[0.5, 1.4, -0.25],
			[-0.4, 1.1, -0.25],
			[0, 0.8, -0.25],
			[0.4, 0.825, 0.175],
			[0.375, 1.05, 0.3],
			[0, 1.2, 0.4],
			[-0.375, 1, 0.3],
			[0.4, 0.825, 0.175],
			[-0.2, 1.1, -0.25],
		],
		//RIGHT BOTTOM LOOP (Entry and Exit through top face)
		spline4: [
			[0.15, 0.15, 0.175],
			[0.2, 1.15, 0.175],
			[0.1, 1.4, 0.4],
		],
		//LEFT BOTTOM LOOP (Entry and Exit through top face)
		spline5: [
			[-0.15, 1.3, 0.175],
			[-0.15, 0.15, 0.175],
		],
		//LEFT BACK LOOP (Entry from left face, Exit through bottom face)
		spline6: [
			[0, 1.45, -0.25],
			[-0.5, 1.4, -0.25],
		]
	}

	var junctionCornerLoop = {
		//FIRST PASS: 2 (separate)
		//SECOND PASS: 3, 5 (cube below), 1, 4 (cube below), 6

		//SPLINE 1 MAIN FRONT LOOP (Entry and Exit through bottom face)
		spline1: [
			[-0.141, -0.283, -0.25],
			[-0.159, -0.407, 0.175],
			[-0.265, -0.265, 0.3],
			[-0.212, 0.212, 0.4],
			[0.265, 0.265, 0.3],
			[0.407, 0.159, 0.175],
			[0.283, 0.141, -0.25],
		],
		//SPLINE 2 SECOND FRONT LOOP (Entry through left face, Exit through right face)
		spline2: [
			[0, 0.5, -0.25],
			[-0.035, 0.177, -0.25],
			[-0.336, -0.23, 0.175],
			[-0.442, -0.088, 0.3],
			[-0.318, 0.318, 0.4],
			[0.088, 0.442, 0.3],
			[0.23, 0.336, 0.175],
			[-0.318, 0.177, -0.25],
			[-0.5, 0, -0.25],
		],
		//SPLINE 3 MAIN BACK LOOP (Entry through right face, Exit through bottom face)
		spline3: [
			[-1, 1.5, -0.25],
			[-1.285, 1.285, -0.25],
			[-1.311, 0.745, -0.25],
			[-0.816, 0.816, -0.25],
			[-0.551, 1.116, 0.175],
			[-0.727, 1.285, 0.3],
			[-1.099, 1.099, 0.4],
			[-1.222, 0.672, 0.3],
			[-1.116, 0.551, 0.175],
			[-1.169, 0.886, -0.25],
		],
		//SPLINE 4 RIGHT BOTTOM LOOP (Entry and Exit through top face)
		spline4: [
			[-1.169, 1.311, 0.4],
			[-0.922, 1.205, 0.175],
			[0.071, 0.283, 0.175],
		],
		//SPLINE 5 LEFT BOTTOM LOOP (Entry and Exit through top face)
		spline5: [
			[-1.275, 1.063, 0.175],
			[-0.283, -0.071, 0.175],
		],
		//SPLINE 6 LEFT BACK LOOP (Entry from left face, Exit through bottom face)
		spline6: [
			[-1.5, 1, -0.25],
			[-1.285, 1.285, -0.25],
		]
	}

	var revOrder = order.slice(0).reverse();

	var nodes = [];
	//stack[z][x][y]

	var stack = [];
	for(var k = 0; k < sizeZ; k++){
		var slice = [];
		for(var i = 0; i < sizeXY; i++){
			var row = [];
			for(var j = 0; j < sizeXY; j++){
				var above;
				if(k < sizeZ - 1){above = [i,j,k+1]}
				var below;
				if(k > 0){below = [i,j,k-1]}
				row.push({x: i, y: j, z: k, transform: [], above: above, below: below});
			}
			slice.push(row);
		}
		stack.push(slice);
	}

	for(var k = 0; k < sizeZ; k++){
		for(var a = 0; a < order.length; a++){
			var thisNode;
			var thisDir;
			var transform;
			
			var i = order[a].i;
			var j = order[a].j;

			thisDir = order[a].dir;

			//transform MIGHT BE WRONG FIX THIS
			if(thisDir == "n"){
				transform = math.matrix([
					//90 degree rotation
					[0, -1, 0, i],
					[1, 0, 0, j],
					[0, 0, 1, k],
					[0, 0, 0, 1]
				]);
			}
			else if(thisDir == "e"){
				transform = math.matrix([
					//180 degree rotation
					[-1, 0, 0, i],
					[0, -1, 0, j],
					[0, 0, 1, k],
					[0, 0, 0, 1]
				]);
			}
			else if(thisDir == "w"){
				transform = math.matrix([
					//270 degree rotation
					[0, 1, 0, i],
					[-1, 0, 0, j],
					[0, 0, 1, k],
					[0, 0, 0, 1]
				]);
			}
			else if(thisDir == "s"){
				transform = math.matrix([
					//0 degree rotation
					[1, 0, 0, i],
					[0, 1, 0, j],
					[0, 0, 1, k],
					[0, 0, 0, 1]
				]);
			}
			else{
				transform = math.matrix([
					[1, 0, 0, 0],
					[0, 1, 0, 0],
					[0, 0, 1, 0],
					[0, 0, 0, 1]
				]);
			}

			stack[k][i][j].transform = transform;

			if(order[a].connection != null){
				stack[k][i][j].connection = [order[a].connection[0], order[a].connection[1], k];
			}
			if(order[a].type != null){
				if(order[a].type == "normal"){
					stack[k][i][j].splines = {
						spline1: matMultiply(transform, regularLoop.spline1),
						spline2: matMultiply(transform, regularLoop.spline2),
						spline3: matMultiply(transform, regularLoop.spline3)
					};
				}
				else if(order[a].type == "normalCorner"){
					stack[k][i][j].splines = {
						spline1: matMultiply(transform, regularCornerLoop.spline1),
						spline2: matMultiply(transform, regularCornerLoop.spline2),
						spline3: matMultiply(transform, regularCornerLoop.spline3)
					};
				}
				else if(order[a].type == "junction"){
					stack[k][i][j].splines = {
						spline1: matMultiply(transform, junctionLoop.spline1),
						spline2: matMultiply(transform, junctionLoop.spline2),
						spline3: matMultiply(transform, junctionLoop.spline3),
						spline4: matMultiply(transform, junctionLoop.spline4),
						spline5: matMultiply(transform, junctionLoop.spline5),
						spline6: matMultiply(transform, junctionLoop.spline6)
					}
				}
				else if(order[a].type == "junctionCorner"){
					stack[k][i][j].splines = {
						spline1: matMultiply(transform, junctionCornerLoop.spline1),
						spline2: matMultiply(transform, junctionCornerLoop.spline2),
						spline3: matMultiply(transform, junctionCornerLoop.spline3),
						spline4: matMultiply(transform, junctionCornerLoop.spline4),
						spline5: matMultiply(transform, junctionCornerLoop.spline5),
						spline6: matMultiply(transform, junctionCornerLoop.spline6)
					}
				}
			}
			stack[k][i][j].transform = transform;
		}
	}
	console.log("Finished setting splines");
	var path = [];
	var csv = "";

	console.log("started building path");

	for(var z = 0; z < stack.length; z++){
		var o;
		if(z % 2 == 0){
			o = order;
			//right to left (for even)
			for(var i = 0; i < o.length; i++){
				if(o[i].type != null){
					var thisSpline = stack[z][o[i].i][o[i].j];
					if(o[i].type == "normal" || o[i].type == "normalCorner"){
						for(var ind = 0; ind < thisSpline.splines.spline2.length; ind++){
							path.push(thisSpline.splines.spline2[ind]);
						}
						if(z < stack.length - 1){
							//2 -> 1 -> 3
							for(var ind = 0; ind < thisSpline.splines.spline1.length; ind++){
								path.push(stack[z + 1][o[i].i][o[i].j].splines.spline1[ind]);
							}
						}
						else{
							var loop1 = thisSpline.splines.spline1.slice(0);
							for(var a = 0; a < thisSpline.splines.spline1.length; a++){
								loop1[a][2] = loop1[a][2]+1;
								path.push(loop1[a]);
							}
						}
						for(var ind = 0; ind < thisSpline.splines.spline2.length; ind++){
							path.push(thisSpline.splines.spline3[ind]);
						}
					}
					else if (o[i].type == "junction" || o[i].type == "junctionCorner"){
						for(var ind = 0; ind < thisSpline.splines.spline2.length; ind++){
							path.push(thisSpline.splines.spline2[ind]);
						}
					}
					else{
						path.push([o[i].i, o[i].j, z]);
					}
					if(o[i].connection != null){
						var connect = stack[z][o[i].connection[0]][o[i].connection[1]];
						console.log(connect);
						//SECOND PASS: 3, 5 (cube below), 1, 4 (cube below), 6
						if(connect.below != null){
							var connectBelow = stack[connect.below[2]][connect.below[0]][connect.below[1]];
							for(var ind = 0; ind < connect.splines.spline3.length; ind++){
								path.push(connect.splines.spline3[ind]);
							}
							for(var ind = 0; ind < connectBelow.splines.spline5.length; ind++){
								path.push(connectBelow.splines.spline5[ind]);
							}
							for(var ind = 0; ind < connect.splines.spline1.length; ind++){
								path.push(connect.splines.spline1[ind]);
							}
							for(var ind = 0; ind < connectBelow.splines.spline4.length; ind++){
								path.push(connectBelow.splines.spline4[ind]);
							}
							for(var ind = 0; ind < connect.splines.spline6.length; ind++){
								path.push(connect.splines.spline6[ind]);
							}
						}
					}
				}
			}
		}
		else{
			o = revOrder;
			//left to right
			for(var i = 0; i < o.length; i++){
				if(o[i].type != null){
					var thisSpline = stack[z][o[i].i][o[i].j];
					if(o[i].type == "normal" || o[i].type == "normalCorner"){
						//3 -> 1 -> 2 (all reversed)
						for(var ind = thisSpline.splines.spline3.length - 1; ind >= 0; ind--){
							path.push(thisSpline.splines.spline3[ind]);
						}
						if(thisSpline.above != null){
							for(var ind = thisSpline.splines.spline1.length - 1; ind >= 0; ind--){
								path.push(stack[z + 1][o[i].i][o[i].j].splines.spline1[ind]);
							}
						}
						else{
							var loop1 = thisSpline.splines.spline1.slice(0);
							for(var ind = thisSpline.splines.spline1.length - 1; ind >= 0; ind--){
								loop1[a][2] = loop1[a][2]+1;
								path.push(loop1[a]);
							}
						}
						for(var ind = thisSpline.splines.spline2.length - 1; ind >= 0; ind--){
							path.push(thisSpline.splines.spline2[ind]);
						}
					}
					else if (o[i].type == "junction" || o[i].type == "junctionCorner"){
						for(var ind = thisSpline.splines.spline2.length - 1; ind >= 0; ind--){
							path.push(thisSpline.splines.spline2[ind]);
						}
					}
					else{
						path.push([o[i].i, o[i].j, z]);
					}
					if(o[i].connection != null){
						var connect = stack[z][o[i].connection[0]][o[i].connection[1]];
						console.log(connect);
						//SECOND PASS: 6 -> 4 (cube below) -> 1 -> 5 (cube below) -> 3 (all reversed)
						if(connect.below != null){
							var connectBelow = stack[connect.below[2]][connect.below[0]][connect.below[1]];
							for(var ind = connect.splines.spline6.length - 1; ind >= 0; ind--){
								path.push(connect.splines.spline6[ind]);
							}
							for(var ind = connectBelow.splines.spline4.length - 1; ind >= 0; ind--){
								path.push(connectBelow.splines.spline4[ind]);
							}
							for(var ind = connect.splines.spline1.length - 1; ind >= 0; ind--){
								path.push(connect.splines.spline1[ind]);
							}
							for(var ind = connectBelow.splines.spline5.length - 1; ind >= 0; ind--){
								path.push(connectBelow.splines.spline5[ind]);
							}
							for(var ind = connect.splines.spline3.length - 1; ind >= 0; ind--){
								path.push(connect.splines.spline3[ind]);
							}
						}
					}
				}
			}
		}
	}

	for(var a = 0; a < path.length; a++){
		for(var b = 0; b < 3; b++){
			csv += (path[a][b] + ",");
		}
		csv += "\n";
	}

	function matMultiply(trans, arr) {
		var resultingArray = [];
		for(var y = 0; y < arr.length; y++){
			var point = math.transpose([arr[y][0], arr[y][1], arr[y][2], 1]);
			var result = math.multiply(trans, point);
			result._data.splice(3,1)
			resultingArray.push(result._data);
		}
		return resultingArray;
	}
	
</script>
</body>
</html>